<!DOCTYPE html>
<html lang="ru"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <title>Новый рейс • Админ</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
</head>
<body class="app-bg">

<header th:replace="~{fragments/topbar :: topbar}"></header>

<div th:if="${success}" class="notice success" th:text="${success}"></div>
<div th:if="${error}" class="notice error" th:text="${error}"></div>

<main class="page">
    <section class="welcome">
        <h1 th:text="${trip != null and trip.id != null ? 'Редактирование рейса' : 'Новый рейс'}">Новый рейс</h1>
        <p>Выберите маршрут (станция → станция), поезд и время отправления/прибытия.</p>

        <!-- Подсказка если маршрутов нет -->
        <div th:if="${#lists.isEmpty(routes)}" class="alert alert-error">
            Сначала создайте хотя бы один маршрут (Станция → Станция).
        </div>

        <div th:if="${#lists.isEmpty(trains)}" class="alert alert-error">
            Сначала добавьте хотя бы один поезд.
        </div>

    </section>

    <section class="cards-grid">
        <article class="card search-card">
            <form class="form"
                  th:action="${trip != null and trip.id != null} ? @{'/admin/panel/trips/' + ${trip.id} + '/update'} : @{/admin/panel/trips/create}"
                  method="post">

                <!-- Маршрут -->
                <div class="form-group">
                    <label for="routeId">Маршрут</label>
                    <div class="select-wrapper">
                        <select name="routeId" id="routeId" class="custom-select"
                                th:disabled="${#lists.isEmpty(routes)}" required>
                            <option value="" disabled th:selected="${trip == null || trip.route == null}">Выберите маршрут</option>
                            <option th:each="r : ${routes}"
                                    th:value="${r.id}"
                                    th:text="${r.origin.name + ' — ' + r.destination.name}"
                                    th:selected="${trip != null and trip.route != null and trip.route.id == r.id}">
                            </option>
                        </select>
                    </div>
                </div>

                <!-- Поезд -->
                <div class="form-group">
                    <label for="trainId">Поезд</label>
                    <div class="select-wrapper">
                        <select name="trainId" id="trainId" class="custom-select" required>
                            <option value="" disabled th:selected="${trip == null || trip.train == null}">Выберите поезд</option>
                            <option th:each="t : ${trains}"
                                    th:value="${t.id}"
                                    th:text="${t.name + ' (' + t.code + ')'}"
                                    th:selected="${trip != null and trip.train != null and trip.train.id == t.id}">
                            </option>
                        </select>
                    </div>
                </div>

                <!-- Время отправления -->
                <div class="form-group">
                    <label for="departure">Отправление</label>
                    <input id="departure" type="datetime-local" name="departure"
                           th:value="${trip != null && trip.departureTime != null ? #temporals.format(trip.departureTime, 'yyyy-MM-dd''T''HH:mm') : ''}"
                           required>
                </div>

                <!-- Время прибытия -->
                <div class="form-group">
                    <label for="arrival">Прибытие</label>
                    <input id="arrival" type="datetime-local" name="arrival"
                           th:value="${trip != null && trip.arrivalTime != null ? #temporals.format(trip.arrivalTime, 'yyyy-MM-dd''T''HH:mm') : ''}"
                           required>
                </div>

                <!-- Цена -->
                <div class="form-group">
                    <label for="basePrice">Базовая цена (BYN)</label>
                    <input id="basePrice" type="number" name="basePrice"
                           step="0.01" min="0"
                           th:value="${trip != null ? trip.basePrice : ''}"
                           required>
                </div>

                <button class="btn primary w-100" type="submit"
                        th:disabled="${#lists.isEmpty(routes) or #lists.isEmpty(trains)}">
                    <span th:text="${trip != null and trip.id != null ? 'Сохранить изменения' : 'Создать рейс'}">Создать рейс</span>
                </button>

                <div class="actions centered">
                    <a class="btn" th:href="@{/admin/panel/trips}">Назад к рейсам</a>
                </div>
            </form>
        </article>
    </section>
</main>

<script>
    // Небольшой UX: ставим ближайшее время по умолчанию
    document.addEventListener("DOMContentLoaded", () => {
        const dep = document.getElementById("departure");
        const arr = document.getElementById("arrival");

        const pad = (n) => String(n).padStart(2, "0");
        const toLocalDatetime = (d) =>
            `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;

        if (dep && !dep.value) {
            const d = new Date();
            d.setMinutes(d.getMinutes() + 10);
            dep.value = toLocalDatetime(d);
        }

        if (arr && !arr.value) {
            const a = new Date();
            a.setHours(a.getHours() + 4);
            arr.value = toLocalDatetime(a);
        }
    });
</script>

</body>
</html>
