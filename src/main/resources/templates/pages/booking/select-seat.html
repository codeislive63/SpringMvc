<!DOCTYPE html>
<html lang="ru"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Выбор места • Railway Booker</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">

    <style>
        /* ===== fixes only for JavaFX WebView ===== */
        .is-javafx .extras-grid{
            display: flex !important;
            flex-wrap: wrap !important;
            margin: -6px !important;
            gap: 0 !important;
        }

        .is-javafx .extras-grid > *{
            width: calc(50% - 12px) !important;
            margin: 6px !important;
        }

        .is-javafx .extras-grid .form-group{
            width: calc(100% - 12px) !important;
        }

        .is-javafx .service-card{
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
        }

        .is-javafx .service-card input{
            flex: 0 0 auto !important;
        }

        .is-javafx .service-icon{
            flex: 0 0 auto !important;
        }

        .is-javafx .service-card span{
            min-width: 0 !important;
            white-space: normal !important;
            overflow-wrap: anywhere !important;
        }

        @media (max-width: 980px){
            .is-javafx .extras-grid > *{
                width: calc(100% - 12px) !important;
            }
        }

    </style>
</head>
<body class="app-bg">

<header th:replace="~{fragments/topbar :: topbar}"></header>

<main class="page page-wide">
    <section class="welcome">
        <h1>Выбор места</h1>
        <p class="muted">Сначала выберите место для первого сегмента. Для маршрута с пересадкой второй сегмент станет активен после выбора места в первом. Свободные места подсвечены зелёным, занятые — серым.</p>
    </section>

    <form th:action="@{/booking/reserve}" method="post">
        <section class="booking-shell">
            <div class="booking-primary">
                <!-- SINGLE TRIP -->
                <div th:if="${tripId != null}" class="stacked-grid">
                    <article class="card seat-card wide-card">
                        <div class="card-header between">
                            <div>
                                <p class="eyebrow">Сегмент 1</p>
                                <h3 th:text="${routeLabel}">Маршрут</h3>
                                <div class="row wrap">
                                    <span class="metric">Рейс: <b th:text="${tripId}"></b></span>
                                    <span class="metric" th:if="${trip != null}">
                                        Свободных мест: <b th:text="${#lists.size(seats)}"></b>
                                    </span>
                                    <span class="metric" th:if="${trip != null}">
                                        Поезд: <b th:text="${trip.train.name}"></b>
                                    </span>
                                </div>
                                <div class="info-grid" th:if="${trip != null}">
                                    <span class="pill" th:text="${trip.train.type.label}"></span>
                                    <span class="pill" th:text="${trip.train.carClass.label}"></span>
                                    <span class="pill" th:if="${trip.train.wifiAvailable}">Wi-Fi</span>
                                    <span class="pill" th:if="${trip.train.diningAvailable}">Питание</span>
                                    <span class="pill" th:if="${trip.train.powerOutlets}">Розетки</span>
                                </div>
                            </div>
                            <div class="seat-callout">
                                <p class="muted">Выберите место на схеме вагона.</p>
                                <p class="pill soft">Для бронирования нужно отметить место.</p>
                            </div>
                        </div>

                        <div class="legend emphasised">
                            <span class="legend-item"><span class="legend-swatch free"></span>Свободно</span>
                            <span class="legend-item"><span class="legend-swatch busy"></span>Занято</span>
                            <span class="legend-item"><span class="legend-swatch selected"></span>Вы выбрали</span>
                        </div>
                        <div class="seat-grid" data-target="seat">
                            <button type="button"
                                    class="seat"
                                    th:each="s : ${seatMap}"
                                    th:text="${s.seatNumber}"
                                    th:classappend="${!s.available} ? ' is-busy' : ' is-free'"
                                    th:disabled="${!s.available}"
                                    th:attr="data-seat=${s.seatNumber}"
                                    onclick="pickSeat('seat', this)">
                            </button>
                        </div>

                        <div class="hint" th:if="${trip != null and trip.route != null}">
                            Остановки:
                            <span th:each="stop,iter : ${trip.route.stops}">
                                <span th:text="${stop}"></span><span th:if="${!iter.last}"> • </span>
                            </span>
                        </div>
                    </article>
                </div>

                <!-- TRANSFER (2 segments) -->
                <div th:if="${tripId1 != null}" class="stacked-grid">
                    <article class="card wide-card segment-card">
                        <div class="segment-card__head">
                            <div>
                                <p class="eyebrow">Стыковка</p>
                                <h3>Сегменты поездки</h3>
                                <p class="muted">Выберите сегмент, затем отметьте места по порядку.</p>
                            </div>
                            <span class="pill soft">2 сегмента</span>
                        </div>
                        <div class="segment-switcher segment-switcher--flat">
                            <button type="button"
                                    class="segment-tab is-active"
                                    data-target="segment1Panel"
                                    onclick="switchSegment('segment1Panel')">
                                <div class="segment-tab__top">
                                    <span class="eyebrow">Сегмент 1</span>
                                    <span class="pill soft" th:text="${routeLabelA}">Маршрут 1</span>
                                </div>
                                <div class="segment-tab__bottom">
                                    <span class="muted">Рейс <b th:text="${tripId1}"></b></span>
                                    <span class="pill muted">Свободно <b th:text="${#lists.size(seats1)}"></b></span>
                                </div>
                            </button>

                            <button type="button"
                                    class="segment-tab is-disabled"
                                    data-target="segment2Panel"
                                    id="segment2Tab"
                                    onclick="switchSegment('segment2Panel')"
                                    disabled>
                                <div class="segment-tab__top">
                                    <span class="eyebrow">Сегмент 2</span>
                                    <span class="pill soft" th:text="${routeLabelB}">Маршрут 2</span>
                                </div>
                                <div class="segment-tab__bottom">
                                    <span class="muted">Рейс <b th:text="${tripId2}"></b></span>
                                    <span class="pill muted">Свободно <b th:text="${#lists.size(seats2)}"></b></span>
                                    <span class="pill danger is-inline" id="segment2Lock">Откроется после выбора места</span>
                                </div>
                            </button>
                        </div>
                    </article>

                    <div class="segment-panels segment-panels--wide">
                        <article class="card seat-card wide-card" id="segment1Panel" data-panel>
                            <div class="card-header between">
                                <div>
                                    <h3 th:text="${routeLabelA}">Маршрут 1</h3>
                                    <div class="row wrap">
                                        <p>Рейс: <b th:text="${tripId1}"></b></p>
                                        <p>Свободных мест: <b th:text="${#lists.size(seats1)}"></b></p>
                                    </div>
                                    <div class="info-grid" th:if="${tripA != null}">
                                        <span class="pill" th:text="${tripA.train.type.label}"></span>
                                        <span class="pill" th:text="${tripA.train.carClass.label}"></span>
                                        <span class="pill" th:if="${tripA.train.wifiAvailable}">Wi-Fi</span>
                                        <span class="pill" th:if="${tripA.train.diningAvailable}">Питание</span>
                                        <span class="pill" th:if="${tripA.train.powerOutlets}">Розетки</span>
                                    </div>
                                </div>
                                <div class="seat-callout">
                                    <p class="muted">Сначала выберите место для первого сегмента.</p>
                                    <p class="pill soft">Затем сразу перейдёте ко второму.</p>
                                </div>
                            </div>

                            <div class="legend emphasised">
                                <span class="legend-item"><span class="legend-swatch free"></span>Свободно</span>
                                <span class="legend-item"><span class="legend-swatch busy"></span>Занято</span>
                                <span class="legend-item"><span class="legend-swatch selected"></span>Вы выбрали</span>
                            </div>
                            <div class="seat-grid" data-target="seat1">
                                <button type="button"
                                        class="seat"
                                        th:each="s1 : ${seatMap1}"
                                        th:text="${s1.seatNumber}"
                                        th:classappend="${!s1.available} ? ' is-busy' : ' is-free'"
                                        th:disabled="${!s1.available}"
                                        th:attr="data-seat=${s1.seatNumber}"
                                        onclick="pickSeat('seat1', this)">
                                </button>
                            </div>
                            <div class="hint" th:if="${tripA != null and tripA.route != null}">
                                Остановки:
                                <span th:each="stop,iter : ${tripA.route.stops}">
                                    <span th:text="${stop}"></span><span th:if="${!iter.last}"> • </span>
                                </span>
                            </div>
                        </article>

                        <article class="card seat-card wide-card is-hidden" id="segment2Panel" data-panel>
                            <div class="card-header between">
                                <div>
                                    <h3 th:text="${routeLabelB}">Маршрут 2</h3>
                                    <div class="row wrap">
                                        <p>Рейс: <b th:text="${tripId2}"></b></p>
                                        <p>Свободных мест: <b th:text="${#lists.size(seats2)}"></b></p>
                                    </div>
                                    <div class="info-grid" th:if="${tripB != null}">
                                        <span class="pill" th:text="${tripB.train.type.label}"></span>
                                        <span class="pill" th:text="${tripB.train.carClass.label}"></span>
                                        <span class="pill" th:if="${tripB.train.wifiAvailable}">Wi-Fi</span>
                                        <span class="pill" th:if="${tripB.train.diningAvailable}">Питание</span>
                                        <span class="pill" th:if="${tripB.train.powerOutlets}">Розетки</span>
                                    </div>
                                </div>
                                <div class="seat-callout muted" id="segment2Hint">
                                    Станет доступно после выбора места в сегменте 1.
                                </div>
                            </div>

                            <div class="legend emphasised">
                                <span class="legend-item"><span class="legend-swatch free"></span>Свободно</span>
                                <span class="legend-item"><span class="legend-swatch busy"></span>Занято</span>
                                <span class="legend-item"><span class="legend-swatch selected"></span>Вы выбрали</span>
                            </div>
                            <div class="seat-grid" data-target="seat2">
                                <button type="button"
                                        class="seat"
                                        th:each="s2 : ${seatMap2}"
                                        th:text="${s2.seatNumber}"
                                        th:classappend="${!s2.available} ? ' is-busy' : ' is-free'"
                                        th:disabled="${!s2.available}"
                                        th:attr="data-seat=${s2.seatNumber}"
                                        onclick="pickSeat('seat2', this)">
                                </button>
                            </div>
                            <div class="hint" th:if="${tripB != null and tripB.route != null}">
                                Остановки:
                                <span th:each="stop,iter : ${tripB.route.stops}">
                                    <span th:text="${stop}"></span><span th:if="${!iter.last}"> • </span>
                                </span>
                            </div>
                        </article>
                    </div>
                </div>
            </div>

            <div class="booking-secondary">
                <article class="card wide-card passenger-card">
                    <div class="section-title">
                        <div>
                            <h3>Данные пассажира</h3>
                            <p class="muted">Заполните данные или выберите пассажира из списка</p>
                        </div>
                        <div class="chip">Пассажир</div>
                    </div>

                    <div class="passenger-toolbar">
                        <div class="select-wrapper wide">
                            <select id="passengerSelector" class="custom-select">
                                <option value="">Новый пассажир</option>
                            </select>
                        </div>
                        <button class="btn ghost" type="button" id="savePassengerBtn">Сохранить как шаблон</button>
                    </div>

                    <div class="pill-tabs passenger-form-tabs">
                        <button type="button" class="is-active" data-passenger-tab="psMain" onclick="switchPassengerTab('psMain')">Основная информация</button>
                        <button type="button" data-passenger-tab="psDocs" onclick="switchPassengerTab('psDocs')">Документы и льготы</button>
                    </div>

                    <!-- ВАЖНО:
                         БЭКУ НУЖНЫ строки passengerName и passengerDocument.
                         Мы их оставляем hidden и собираем из полей ниже через JS,
                         чтобы ничего в /booking/reserve не ломать. -->
                    <input type="hidden" id="passengerName" name="passengerName" required>
                    <input type="hidden" id="passengerDocument" name="passengerDocument" required>

                    <div class="passenger-pane" id="psMain">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="lastName">Фамилия</label>
                                <input id="lastName" type="text" placeholder="Иванов" required>
                            </div>
                            <div class="form-group">
                                <label for="firstName">Имя</label>
                                <input id="firstName" type="text" placeholder="Иван" required>
                            </div>
                            <div class="form-group">
                                <label for="middleName">Отчество</label>
                                <input id="middleName" type="text" placeholder="Иванович">
                            </div>

                            <div class="form-group">
                                <label>Пол</label>
                                <div class="row wrap">
                                    <label class="muted"><input type="radio" name="genderUi" value="M" required> Мужской</label>
                                    <label class="muted"><input type="radio" name="genderUi" value="F" required> Женский</label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="birthDate">Дата рождения</label>
                                <input id="birthDate" type="date" required>
                            </div>

                            <div class="form-group">
                                <label for="loyaltyNumber">Номер бонусной карты</label>
                                <input id="loyaltyNumber" name="loyaltyNumber" type="text" placeholder="RB-000001">
                            </div>
                        </div>
                    </div>

                    <div class="passenger-pane is-hidden" id="psDocs">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="docType">Тип документа</label>
                                <div class="select-wrapper">
                                    <select id="docType" class="custom-select" required>
                                        <option value="Паспорт">Паспорт</option>
                                        <option value="ID">ID карта</option>
                                        <option value="Загранпаспорт">Загранпаспорт</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="docNumber">Номер документа</label>
                                <input id="docNumber" type="text" placeholder="00 00 №123456" required>
                            </div>

                            <div class="form-group">
                                <label for="benefitType">Льготы</label>
                                <div class="select-wrapper">
                                    <select id="benefitType" name="benefitType" class="custom-select">
                                        <option value="">Без льготы</option>
                                        <option value="student">Студент</option>
                                        <option value="pensioner">Пенсионер</option>
                                        <option value="military">Ветеран</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mt-10">
                            <label class="muted">
                                <input type="checkbox" name="childTicket" id="childTicket" value="true">
                                Детский билет (50% скидка)
                            </label>
                        </div>
                    </div>
                </article>

                <!-- Дополнительные услуги -->
                <article class="card wide-card">
                    <div class="section-title">
                        <div>
                            <h3>Дополнительные услуги</h3>
                        </div>
                    </div>
                    <div class="extras-grid">
                        <label class="service-card">
                          <span class="service-left">
                            <input type="checkbox" name="insuranceIncluded" value="true">
                          </span>
                            <span class="service-text">Страхование поездки</span>
                        </label>
                        <label class="service-card">
                          <span class="service-left">
                            <input type="checkbox" name="transferIncluded" value="true">
                          </span>
                            <span class="service-text">Такси</span>
                        </label>
                        <label class="service-card">
                          <span class="service-left">
                            <input type="checkbox" name="petTravel" value="true">
                          </span>
                            <span class="service-text">Перевозка животных</span>
                        </label>
                        <label class="service-card">
                          <span class="service-left">
                            <input type="checkbox" name="baggageSelected" value="true">
                          </span>
                            <span class="service-text">Доп. багаж</span>
                        </label>

                        <div class="form-group" style="grid-column: span 2;">
                            <label for="mealOption">Питание</label>
                            <div class="select-wrapper">
                                <select id="mealOption" name="mealOption" class="custom-select">
                                    <option value="">Без питания</option>
                                    <option value="standard">Стандарт</option>
                                    <option value="vegan">Веган</option>
                                    <option value="kids">Детское</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </article>
            </div>
        </section>

        <!-- Скрытые поля -->
        <input type="hidden" name="tripId" th:value="${tripId}"/>
        <input type="hidden" name="tripId1" th:value="${tripId1}"/>
        <input type="hidden" name="tripId2" th:value="${tripId2}"/>
        <input type="hidden" name="seat" id="seat"/>
        <input type="hidden" name="seat1" id="seat1"/>
        <input type="hidden" name="seat2" id="seat2"/>

        <!-- Сводка выбора -->
        <div class="selection-summary">
            <div class="summary-item" th:if="${tripId != null}">
                <p class="muted">Сегмент 1</p>
                <p class="summary-value" id="seatSummarySingle">Не выбрано</p>
            </div>
            <div class="summary-item" th:if="${tripId1 != null}">
                <p class="muted">Сегмент 1</p>
                <p class="summary-value" id="seatSummary1">Не выбрано</p>
            </div>
            <div class="summary-item" th:if="${tripId1 != null}">
                <p class="muted">Сегмент 2</p>
                <p class="summary-value" id="seatSummary2">Не выбрано</p>
            </div>
            <div class="summary-item important">
                <p class="muted">Пассажир</p>
                <p class="summary-value" id="passengerSummary">Введите данные или выберите сохранённого</p>
            </div>
        </div>

        <!-- Кнопки -->
        <div class="actions mt-16">
            <button class="btn primary" type="submit" id="reserveBtnSingle" th:if="${tripId != null}" disabled>Забронировать</button>
            <button class="btn primary" type="submit" id="reserveBtnTransfer" th:if="${tripId1 != null}" disabled>Забронировать</button>
            <a class="btn secondary" th:href="@{/routes/search}">Назад</a>
        </div>
    </form>
</main>

<script th:src="@{/js/passenger-templates.js}"></script>
<script>
    function pickSeat(hiddenId, btn) {
        const grid = btn.closest('.seat-grid');
        if (grid) {
            grid.querySelectorAll('.seat').forEach(b => b.classList.remove('is-selected'));
        }
        btn.classList.add('is-selected');

        const hidden = document.getElementById(hiddenId);
        if (hidden) hidden.value = btn.dataset.seat;

        if (hiddenId === 'seat1') enableSecondSegment();

        syncActions();
        updateSelectionSummary();
    }

    function enableSecondSegment() {
        const tab = document.getElementById('segment2Tab');
        const lock = document.getElementById('segment2Lock');
        const hint = document.getElementById('segment2Hint');
        if (tab) {
            tab.disabled = false;
            tab.classList.remove('is-disabled');
        }
        if (lock) lock.classList.add('is-hidden');
        if (hint) hint.classList.remove('muted');
        switchSegment('segment2Panel');
    }

    function switchSegment(targetId) {
        document.querySelectorAll('[data-panel]').forEach(panel => {
            panel.classList.toggle('is-hidden', panel.id !== targetId);
        });
        document.querySelectorAll('.segment-tab').forEach(tab => {
            tab.classList.toggle('is-active', tab.dataset.target === targetId);
        });
    }

    function switchPassengerTab(targetId) {
        document.querySelectorAll('.passenger-pane').forEach(pane => {
            pane.classList.toggle('is-hidden', pane.id !== targetId);
        });
        document.querySelectorAll('.passenger-form-tabs button').forEach(btn => {
            btn.classList.toggle('is-active', btn.dataset.passengerTab === targetId);
        });
    }

    function syncActions() {
        const singleBtn = document.getElementById('reserveBtnSingle');
        if (singleBtn) {
            const seat = document.getElementById('seat')?.value;
            singleBtn.disabled = !(seat && seat.length > 0);
        }

        const transferBtn = document.getElementById('reserveBtnTransfer');
        if (transferBtn) {
            const seat1 = document.getElementById('seat1')?.value;
            const seat2 = document.getElementById('seat2')?.value;
            transferBtn.disabled = !(seat1 && seat2);
        }

        updatePassengerSummary();
    }

    function updateSelectionSummary() {
        const seat = document.getElementById('seat')?.value;
        const seat1 = document.getElementById('seat1')?.value;
        const seat2 = document.getElementById('seat2')?.value;
        const single = document.getElementById('seatSummarySingle');
        if (single) single.textContent = seat ? `Место ${seat}` : 'Не выбрано';
        const s1 = document.getElementById('seatSummary1');
        if (s1) s1.textContent = seat1 ? `Место ${seat1}` : 'Не выбрано';
        const s2 = document.getElementById('seatSummary2');
        if (s2) s2.textContent = seat2 ? `Место ${seat2}` : 'Не выбрано';
    }

    // -------- Passenger logic (v2 unified) --------

    function buildPassengerName() {
        const ln = document.getElementById('lastName').value.trim();
        const fn = document.getElementById('firstName').value.trim();
        const mn = document.getElementById('middleName').value.trim();
        return [ln, fn, mn].filter(Boolean).join(' ');
    }

    function buildPassengerDocument() {
        const t = document.getElementById('docType').value.trim();
        const n = document.getElementById('docNumber').value.trim();
        return [t, n].filter(Boolean).join(' ');
    }

    function syncHiddenPassengerFields() {
        document.getElementById('passengerName').value = buildPassengerName();
        document.getElementById('passengerDocument').value = buildPassengerDocument();
        updatePassengerSummary();
    }

    function readPassengerFromForm(existingId) {
        const gender = document.querySelector('input[name="genderUi"]:checked')?.value || "";
        return {
            id: existingId || null,
            lastName: document.getElementById('lastName').value.trim(),
            firstName: document.getElementById('firstName').value.trim(),
            middleName: document.getElementById('middleName').value.trim(),
            gender,
            birthDate: document.getElementById('birthDate').value || "",
            docType: document.getElementById('docType').value || "",
            docNumber: document.getElementById('docNumber').value.trim(),
            benefitType: document.getElementById('benefitType').value || "",
            loyaltyNumber: document.getElementById('loyaltyNumber').value.trim(),
            childTicket: !!document.getElementById('childTicket')?.checked
        };
    }

    function fillPassengerForm(p) {
        document.getElementById('lastName').value = p.lastName || "";
        document.getElementById('firstName').value = p.firstName || "";
        document.getElementById('middleName').value = p.middleName || "";

        if (p.gender === "M" || p.gender === "F") {
            const rb = document.querySelector(`input[name="genderUi"][value="${p.gender}"]`);
            if (rb) rb.checked = true;
        } else {
            document.querySelectorAll('input[name="genderUi"]').forEach(x => x.checked = false);
        }

        document.getElementById('birthDate').value = p.birthDate || "";
        document.getElementById('docType').value = p.docType || "Паспорт";
        document.getElementById('docNumber').value = p.docNumber || "";
        document.getElementById('benefitType').value = p.benefitType || "";
        document.getElementById('loyaltyNumber').value = p.loyaltyNumber || "";
        const child = document.getElementById('childTicket');
        if (child) child.checked = !!p.childTicket;

        syncHiddenPassengerFields();
    }

    function clearPassengerForm() {
        document.getElementById('lastName').value = "";
        document.getElementById('firstName').value = "";
        document.getElementById('middleName').value = "";
        document.querySelectorAll('input[name="genderUi"]').forEach(x => x.checked = false);
        document.getElementById('birthDate').value = "";
        document.getElementById('docType').value = "Паспорт";
        document.getElementById('docNumber').value = "";
        document.getElementById('benefitType').value = "";
        document.getElementById('loyaltyNumber').value = "";
        const child = document.getElementById('childTicket');
        if (child) child.checked = false;

        syncHiddenPassengerFields();
    }

    function updatePassengerSummary() {
        const summary = document.getElementById('passengerSummary');
        if (!summary) return;

        const name = document.getElementById('passengerName')?.value?.trim();
        const doc = document.getElementById('passengerDocument')?.value?.trim();

        summary.textContent = (name && doc)
            ? `${name}, ${doc}`
            : 'Введите данные или выберите сохранённого';
    }

    function renderPassengerOptions(selectedId) {
        PassengerTemplates.fillSelect(document.getElementById('passengerSelector'), selectedId);
    }

    function handlePassengerSelect(value) {
        if (!value) {
            clearPassengerForm();
            updatePassengerSummary();
            return;
        }
        const p = PassengerTemplates.getById(value);
        if (!p) {
            clearPassengerForm();
            updatePassengerSummary();
            return;
        }
        fillPassengerForm(p);
        updatePassengerSummary();
    }

    function savePassengerTemplate() {
        // минимальная валидация: ФИО + документ
        const name = buildPassengerName();
        const doc = buildPassengerDocument();
        if (!name || !doc) {
            alert('Заполните ФИО и документ, чтобы сохранить пассажира.');
            return;
        }

        const currentSelected = document.getElementById('passengerSelector').value || null;
        const passenger = readPassengerFromForm(currentSelected || undefined);
        const saved = PassengerTemplates.upsert(passenger);

        renderPassengerOptions(saved.id);
        document.getElementById('passengerSelector').value = saved.id;
        updatePassengerSummary();
    }

    // listeners
    document.addEventListener('DOMContentLoaded', () => {
        renderPassengerOptions();
        updateSelectionSummary();
        syncActions();

        const firstTab = document.querySelector('.segment-tab.is-active');
        if (firstTab) switchSegment(firstTab.dataset.target);
        switchPassengerTab('psMain');

        document.getElementById('passengerSelector').addEventListener('change', (e) => {
            handlePassengerSelect(e.target.value);
        });

        document.getElementById('savePassengerBtn').addEventListener('click', savePassengerTemplate);

        // любое изменение полей -> обновляем hidden passengerName/passengerDocument и summary
        const watchedIds = ["lastName","firstName","middleName","birthDate","docType","docNumber","benefitType","loyaltyNumber","childTicket"];
        watchedIds.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('input', syncHiddenPassengerFields);
            el.addEventListener('change', syncHiddenPassengerFields);
        });
        document.querySelectorAll('input[name="genderUi"]').forEach(el => {
            el.addEventListener('change', syncHiddenPassengerFields);
        });

        // первичная синхронизация
        syncHiddenPassengerFields();
    });
</script>

</body>
</html>
