<!DOCTYPE html>
<html lang="ru"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Поиск маршрута • Railway Booker</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
</head>
<body class="app-bg">

<header th:replace="~{fragments/topbar :: topbar}"></header>

<main class="page">
    <section class="welcome">
        <h1>Поиск маршрута</h1>
        <p>Выберите станции отправления и назначения, а также дату поездки</p>

        <div th:if="${error}" class="alert error" th:text="${error}"></div>
    </section>

    <section class="cards-grid">
        <article class="card search-card">
            <form class="form" th:action="@{/routes/search}" th:object="${req}" method="get">

                <div class="form-group">
                    <label for="fromPointName">Откуда</label>
                    <div class="autocomplete">
                        <input id="fromPointName"
                               type="text"
                               name="fromPointName"
                               placeholder="Начните вводить город или станцию"
                               autocomplete="off"
                               th:value="${req.fromPointName}">
                        <input type="hidden" id="fromPointId" name="fromPointId" th:value="${req.fromPointId}">
                        <div class="suggestions" id="fromPointSuggestions"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="toPointName">Куда</label>
                    <div class="autocomplete">
                        <input id="toPointName"
                               type="text"
                               name="toPointName"
                               placeholder="Начните вводить город или станцию"
                               autocomplete="off"
                               th:value="${req.toPointName}">
                        <input type="hidden" id="toPointId" name="toPointId" th:value="${req.toPointId}">
                        <div class="suggestions" id="toPointSuggestions"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="departureDate">Дата отправления</label>
                    <input id="departureDate" type="date" th:field="*{departureDate}" required>
                </div>

                <div class="form-group two-col">
                    <div>
                        <label for="trainType">Тип поезда</label>
                        <div class="select-wrapper">
                            <select id="trainType" class="custom-select" name="trainType">
                                <option value="">Любой</option>
                                <option th:each="t : ${trainTypes}"
                                        th:value="${t}"
                                        th:text="${t.label}"
                                        th:selected="${req.trainType != null and req.trainType == t}"></option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="carClass">Класс вагона</label>
                        <div class="select-wrapper">
                            <select id="carClass" class="custom-select" name="carClass">
                                <option value="">Любой</option>
                                <option th:each="c : ${carClasses}"
                                        th:value="${c}"
                                        th:text="${c.label}"
                                        th:selected="${req.carClass != null and req.carClass == c}"></option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group two-col">
                    <div>
                        <label for="departureFrom">Время отправления с</label>
                        <input id="departureFrom" type="time" name="departureFrom" th:value="${req.departureFrom}">
                    </div>
                    <div>
                        <label for="arrivalTo">Прибытие до</label>
                        <input id="arrivalTo" type="time" name="arrivalTo" th:value="${req.arrivalTo}">
                    </div>
                </div>

                <div class="form-group">
                    <label for="maxPrice">Макс. цена (BYN)</label>
                    <input id="maxPrice" type="number" min="0" step="1" name="maxPrice" th:value="${req.maxPrice}">
                </div>

                <button class="btn primary w-100" type="submit">Найти</button>
            </form>
        </article>
    </section>
</main>

<script>
    const debounce = (fn, delay = 180) => {
        let t;
        return (...args) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...args), delay);
        };
    };

    async function fetchStations(query) {
        const resp = await fetch(`/routes/stations?q=${encodeURIComponent(query)}`);
        if (!resp.ok) return [];
        return resp.json();
    }

    function wireAutocomplete(inputId, hiddenId, listId) {
        const input = document.getElementById(inputId);
        const hidden = document.getElementById(hiddenId);
        const list = document.getElementById(listId);
        if (!input || !hidden || !list) return;

        const render = (items) => {
            list.innerHTML = "";
            if (!items.length) {
                list.classList.remove("is-open");
                return;
            }
            items.forEach(item => {
                const row = document.createElement("button");
                row.type = "button";
                row.className = "suggestion-row";
                row.textContent = `${item.name} (${item.code})`;
                row.addEventListener("click", () => {
                    input.value = item.name;
                    hidden.value = item.id;
                    list.classList.remove("is-open");
                    input.setCustomValidity("");
                });
                list.appendChild(row);
            });
            list.classList.add("is-open");
        };

        const handleInput = debounce(async () => {
            const q = input.value.trim();
            hidden.value = "";
            if (q.length < 2) {
                list.classList.remove("is-open");
                return;
            }
            const items = await fetchStations(q);
            render(items);
        });

        input.addEventListener("input", handleInput);
        input.addEventListener("focus", () => input.dispatchEvent(new Event("input")));
        document.addEventListener("click", (e) => {
            if (!list.contains(e.target) && e.target !== input) {
                list.classList.remove("is-open");
            }
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        const d = document.getElementById("departureDate");
        if (d && !d.value) d.value = new Date().toISOString().slice(0,10);

        wireAutocomplete("fromPointName", "fromPointId", "fromPointSuggestions");
        wireAutocomplete("toPointName", "toPointId", "toPointSuggestions");

        const form = document.querySelector("form.form");
        form?.addEventListener("submit", (e) => {
            const fromId = document.getElementById("fromPointId");
            const toId = document.getElementById("toPointId");
            if (!fromId.value || !toId.value) {
                e.preventDefault();
                if (!fromId.value) document.getElementById("fromPointName").setCustomValidity("Выберите станцию из списка");
                if (!toId.value) document.getElementById("toPointName").setCustomValidity("Выберите станцию из списка");
                (document.getElementById("fromPointName").reportValidity());
                (document.getElementById("toPointName").reportValidity());
            }
        });
    });
</script>

</body>
</html>
