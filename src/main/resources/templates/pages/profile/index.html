<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
</head>

<body class="app-bg">
<header th:replace="~{fragments/topbar :: topbar}"></header>

<div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
<div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

<main class="page">
    <section class="welcome">
        <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
        <p class="muted">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª–µ–º, –ø–∞—Å—Å–∞–∂–∏—Ä–∞–º–∏ –∏ –±–∏–ª–µ—Ç–∞–º–∏.</p>
    </section>

    <section class="profile-layout">

        <nav class="profile-tabs pill-tabs">
            <button type="button" class="is-active" data-target="tabProfile">–ü—Ä–æ—Ñ–∏–ª—å</button>
            <button type="button" data-target="tabPassengers">–ü–∞—Å—Å–∞–∂–∏—Ä—ã</button>
            <button type="button" data-target="tabBookings">–ê–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏</button>
            <button type="button" data-target="tabPurchases">–ü–æ–∫—É–ø–∫–∏</button>
            <button type="button" data-target="tabCancelled">–û—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ</button>
        </nav>

        <!-- –ü–†–û–§–ò–õ–¨ -->
        <div class="tab-content" id="tabProfile">
            <article class="card wide-card profile-card">
                <h2>–£—á—ë—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å</h2>
                <p class="muted">–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –±–æ–Ω—É—Å—ã.</p>

                <dl class="kv">
                    <dt>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</dt>
                    <dd th:text="${user.fullName}">–ü–∞—Å—Å–∞–∂–∏—Ä</dd>

                    <dt>Email</dt>
                    <dd th:text="${user.email}">customer@example.com</dd>

                    <dt>–£—Ä–æ–≤–µ–Ω—å</dt>
                    <dd th:text="${loyaltyTier}">–ë–∞–∑–æ–≤—ã–π</dd>

                    <dt>–ë–æ–Ω—É—Å–Ω—ã–µ –±–∞–ª–ª—ã</dt>
                    <dd th:text="${loyaltyPoints}">160</dd>
                </dl>
            </article>
        </div>

        <div class="tab-content is-hidden" id="tabPassengers">
            <div class="passenger-board">

                <article class="card wide-card passenger-list-card">
                    <div class="card-header between">
                        <div>
                            <h2>–ü–∞—Å—Å–∞–∂–∏—Ä—ã</h2>
                            <p class="muted">–®–∞–±–ª–æ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ –¥–æ—Å—Ç—É–ø–Ω—ã –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –±–∏–ª–µ—Ç–æ–≤</p>
                        </div>
                        <button class="btn primary" type="button" onclick="startCreatePassenger()">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Å—Å–∞–∂–∏—Ä–∞</button>
                    </div>

                    <div class="passenger-list-shell">
                        <div class="passenger-search">
                            <span style="opacity:.7">üîé</span>
                            <input id="passengerSearch"
                                   type="text"
                                   placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç—É"
                                   oninput="renderPassengerList()">
                        </div>

                        <div id="passengerList" class="passenger-stack"></div>

                        <p class="muted" id="passengerEmpty" style="display:none;">
                            –ü–æ–∫–∞ –Ω–µ—Ç –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤. –ù–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Å—Å–∞–∂–∏—Ä–∞¬ª.
                        </p>
                    </div>
                </article>

                <article class="card wide-card passenger-editor-card">

                    <div class="card-header between">
                        <div>
                            <h2 id="passengerEditorTitle">–ù–æ–≤—ã–π –ø–∞—Å—Å–∞–∂–∏—Ä</h2>
                            <p class="muted">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —à–∞–±–ª–æ–Ω.</p>
                        </div>
                    </div>

                    <div class="pill-tabs passenger-form-tabs">
                        <button type="button"
                                class="is-active"
                                data-passenger-tab="profileMain"
                                onclick="switchProfilePassengerTab('profileMain')">
                            –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                        </button>
                        <button type="button"
                                data-passenger-tab="profileDocs"
                                onclick="switchProfilePassengerTab('profileDocs')">
                            –î–æ–∫—É–º–µ–Ω—Ç—ã –∏ –ª—å–≥–æ—Ç—ã
                        </button>
                    </div>

                    <div class="passenger-pane" id="profileMain">
                        <div class="form-grid" style="margin-top: 10px;">
                            <div class="form-group">
                                <label>–§–∞–º–∏–ª–∏—è</label>
                                <input id="pLastName" type="text" placeholder="–ò–≤–∞–Ω–æ–≤">
                            </div>
                            <div class="form-group">
                                <label>–ò–º—è</label>
                                <input id="pFirstName" type="text" placeholder="–ò–≤–∞–Ω">
                            </div>
                            <div class="form-group">
                                <label>–û—Ç—á–µ—Å—Ç–≤–æ</label>
                                <input id="pMiddleName" type="text" placeholder="–ò–≤–∞–Ω–æ–≤–∏—á">
                            </div>

                            <div class="form-group">
                                <label>–ü–æ–ª</label>
                                <div class="row pill-buttons">
                                    <button class="btn ghost" type="button" id="pGenderM" onclick="setGender('M')">–ú—É–∂—Å–∫–æ–π</button>
                                    <button class="btn ghost" type="button" id="pGenderF" onclick="setGender('F')">–ñ–µ–Ω—Å–∫–∏–π</button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                                <input id="pBirthDate" type="date">
                            </div>
                        </div>
                    </div>

                    <div class="passenger-pane is-hidden" id="profileDocs">
                        <div class="form-grid" style="margin-top: 10px;">
                            <div class="form-group">
                                <label>–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                                <div class="select-wrapper">
                                    <select id="pDocType" class="custom-select">
                                        <option value="PASSPORT">–ü–∞—Å–ø–æ—Ä—Ç</option>
                                        <option value="FOREIGN_PASSPORT">–ó–∞–≥—Ä–∞–Ω–ø–∞—Å–ø–æ—Ä—Ç</option>
                                        <option value="ID">ID-–∫–∞—Ä—Ç–∞</option>
                                        <option value="BIRTH_CERT">–°–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ –æ —Ä–æ–∂–¥–µ–Ω–∏–∏</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                                <input id="pDocNumber" type="text" placeholder="00 00 ‚Ññ123456">
                            </div>

                            <div class="form-group">
                                <label>–õ—å–≥–æ—Ç—ã</label>
                                <div class="select-wrapper">
                                    <select id="pBenefit" class="custom-select">
                                        <option value="">–ë–µ–∑ –ª—å–≥–æ—Ç—ã</option>
                                        <option value="student">–°—Ç—É–¥–µ–Ω—Ç</option>
                                        <option value="pensioner">–ü–µ–Ω—Å–∏–æ–Ω–µ—Ä</option>
                                        <option value="military">–í–µ—Ç–µ—Ä–∞–Ω</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>–ù–æ–º–µ—Ä –±–æ–Ω—É—Å–Ω–æ–π –∫–∞—Ä—Ç—ã</label>
                                <input id="pLoyalty" type="text" placeholder="RB-000001">
                            </div>

                            <div class="form-group">
                                <label class="muted">
                                    <input type="checkbox" id="pChildTicket">
                                    –î–µ—Ç—Å–∫–∏–π –±–∏–ª–µ—Ç (50% —Å–∫–∏–¥–∫–∞)
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="actions mt-16">
                        <button class="btn primary" type="button" onclick="savePassenger()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button class="btn ghost" type="button" onclick="resetPassengerForm()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>
                </article>
            </div>
        </div>

        <!-- –ê–ö–¢–ò–í–ù–´–ï -->
        <div class="tab-content is-hidden" id="tabBookings">
            <article class="card wide-card ticket-collection">
                <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏</h2>

                <div th:if="${#lists.isEmpty(unpaidTickets)}">
                    <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.</p>
                </div>

                <div th:each="t : ${unpaidTickets}" class="ticket-list">
                    <details class="ticket-collapse ticket-panel">
                        <summary>
                            <div class="ticket-summary">
                                <div class="ticket-main">
                                    <div class="ticket-route"
                                         th:text="${t.trip.route.origin.name + ' ‚Äî ' + t.trip.route.destination.name}">
                                        –ú–∞—Ä—à—Ä—É—Ç
                                    </div>

                                    <div class="ticket-meta">
                                        <div class="meta-item">
                                            <div class="label">–î–∞—Ç–∞</div>
                                            <div class="value"
                                                 th:text="${#temporals.format(t.trip.departureTime,'dd.MM.yyyy')}">24.12.2025</div>
                                        </div>
                                        <div class="meta-item">
                                            <div class="label">–í—Ä–µ–º—è</div>
                                            <div class="value"
                                                 th:text="${#temporals.format(t.trip.departureTime,'HH:mm')}">17:15</div>
                                        </div>
                                        <div class="meta-item">
                                            <div class="label">–ú–µ—Å—Ç–æ</div>
                                            <div class="value" th:text="${t.seatNumber}">11</div>
                                        </div>
                                        <div class="meta-item">
                                            <div class="label">–°—Ç–æ–∏–º–æ—Å—Ç—å</div>
                                            <div class="value"
                                                 th:text="${#numbers.formatDecimal(t.price,1,'COMMA',2,'POINT')} + ' BYN'">12.00 BYN</div>
                                        </div>
                                    </div>
                                </div>

                                <span class="status-chip" th:text="${t.status.label}">–ó–ê–ë–†–û–ù–ò–†–û–í–ê–ù–û</span>
                            </div>
                        </summary>

                        <div class="details-body">
                            <p>–°—Ç–∞—Ç—É—Å: <b th:text="${t.status.label}"></b></p>

                            <div class="actions">
                                <form th:action="@{/booking/pay/{id}(id=${t.id})}" method="post">
                                    <button class="btn primary" type="submit">–û–ø–ª–∞—Ç–∏—Ç—å</button>
                                </form>

                                <form th:action="@{/tickets/{id}/refund(id=${t.id})}" method="post"
                                      onsubmit="return confirm('–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å? –ú–µ—Å—Ç–æ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ —Å–Ω–æ–≤–∞.')">
                                    <button class="btn danger" type="submit">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                                </form>
                            </div>
                        </div>
                    </details>
                </div>
            </article>
        </div>

        <!-- –ü–û–ö–£–ü–ö–ò -->
        <div class="tab-content is-hidden" id="tabPurchases">
            <article class="card wide-card ticket-collection">
                <h2>–ü–æ–∫—É–ø–∫–∏</h2>

                <div th:if="${#lists.isEmpty(paidTickets)}">
                    <p>–ù–µ—Ç –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤.</p>
                </div>

                <div th:each="t : ${paidTickets}" class="ticket-list">
                    <details class="ticket-collapse ticket-panel">
                        <summary>
                            <div class="ticket-summary">
                                <div class="ticket-main">
                                    <div class="ticket-route"
                                         th:text="${t.trip.route.origin.name + ' ‚Äî ' + t.trip.route.destination.name}">
                                        –ú–∞—Ä—à—Ä—É—Ç
                                    </div>

                                    <div class="ticket-meta">
                                        <div class="meta-item">
                                            <div class="label">–î–∞—Ç–∞</div>
                                            <div class="value"
                                                 th:text="${#temporals.format(t.trip.departureTime,'dd.MM.yyyy')}">24.12.2025</div>
                                        </div>
                                        <div class="meta-item">
                                            <div class="label">–í—Ä–µ–º—è</div>
                                            <div class="value"
                                                 th:text="${#temporals.format(t.trip.departureTime,'HH:mm')}">17:15</div>
                                        </div>
                                        <div class="meta-item">
                                            <div class="label">–ú–µ—Å—Ç–æ</div>
                                            <div class="value" th:text="${t.seatNumber}">11</div>
                                        </div>
                                        <div class="meta-item">
                                            <div class="label">–°—Ç–æ–∏–º–æ—Å—Ç—å</div>
                                            <div class="value"
                                                 th:text="${#numbers.formatDecimal(t.price,1,'COMMA',2,'POINT')} + ' BYN'">12.00 BYN</div>
                                        </div>
                                    </div>
                                </div>

                                <span class="status-chip" th:text="${t.status.label}">–û–ü–õ–ê–ß–ï–ù–û</span>
                            </div>
                        </summary>

                        <div class="details-body">
                            <p>–°—Ç–∞—Ç—É—Å: <b th:text="${t.status.label}"></b></p>

                            <form th:action="@{/tickets/{id}/refund(id=${t.id})}" method="post"
                                  onsubmit="return confirm('–í–µ—Ä–Ω—É—Ç—å –±–∏–ª–µ—Ç? –°—Ä–µ–¥—Å—Ç–≤–∞ –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã.')">
                                <button class="btn danger" type="submit">–í–µ—Ä–Ω—É—Ç—å</button>
                            </form>
                        </div>
                    </details>
                </div>
            </article>
        </div>

        <!-- –û–¢–ú–ï–ù–Å–ù–ù–´–ï -->
        <div class="tab-content is-hidden" id="tabCancelled">
            <article class="card wide-card ticket-collection">
                <h2>–û—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ</h2>

                <div th:if="${#lists.isEmpty(cancelledTickets)}">
                    <p>–ù–µ—Ç –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â—ë–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤.</p>
                </div>

                <div th:each="t : ${cancelledTickets}" class="ticket-list">
                    <details class="ticket-collapse ticket-panel">
                        <summary>
                            <div class="ticket-summary">
                                <div class="ticket-main">
                                    <div class="ticket-route"
                                         th:text="${t.trip.route.origin.name + ' ‚Äî ' + t.trip.route.destination.name}">
                                        –ú–∞—Ä—à—Ä—É—Ç
                                    </div>

                                    <div class="ticket-meta">
                                        <div class="meta-item">
                                            <div class="label">–î–∞—Ç–∞</div>
                                            <div class="value"
                                                 th:text="${#temporals.format(t.trip.departureTime,'dd.MM.yyyy')}">24.12.2025</div>
                                        </div>
                                        <div class="meta-item">
                                            <div class="label">–í—Ä–µ–º—è</div>
                                            <div class="value"
                                                 th:text="${#temporals.format(t.trip.departureTime,'HH:mm')}">17:15</div>
                                        </div>
                                        <div class="meta-item">
                                            <div class="label">–ú–µ—Å—Ç–æ</div>
                                            <div class="value" th:text="${t.seatNumber}">11</div>
                                        </div>
                                        <div class="meta-item">
                                            <div class="label">–°—Ç–æ–∏–º–æ—Å—Ç—å</div>
                                            <div class="value"
                                                 th:text="${#numbers.formatDecimal(t.price,1,'COMMA',2,'POINT')} + ' BYN'">12.00 BYN</div>
                                        </div>
                                    </div>
                                </div>

                                <span class="status-chip" th:text="${t.status.label}">–û–¢–ú–ï–ù–ï–ù–û</span>
                            </div>
                        </summary>

                        <div class="details-body">
                            <p>–°—Ç–∞—Ç—É—Å: <b th:text="${t.status.label}"></b></p>
                        </div>
                    </details>
                </div>
            </article>
        </div>

    </section>
</main>

<script>
    // –í–∫–ª–∞–¥–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
    document.querySelectorAll('.profile-tabs button').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-content').forEach(div => div.classList.add('is-hidden'));
            document.querySelectorAll('.profile-tabs button').forEach(b => b.classList.remove('is-active'));
            const targetId = btn.dataset.target;
            const target = document.getElementById(targetId);
            if (target) target.classList.remove('is-hidden');
            btn.classList.add('is-active');
        });
    });

    const PASSENGER_STORAGE_KEY = 'rb-passenger-templates';
    let editingPassengerId = null;
    let currentGender = '';

    function setEditorTitle(text) {
        const el = document.getElementById('passengerEditorTitle');
        if (el) el.textContent = text;
    }

    function loadPassengers() {
        try {
            const raw = localStorage.getItem(PASSENGER_STORAGE_KEY);
            return raw ? JSON.parse(raw) : [];
        } catch (e) {
            console.warn('loadPassengers failed', e);
            return [];
        }
    }

    function persistPassengers(list) {
        localStorage.setItem(PASSENGER_STORAGE_KEY, JSON.stringify(list));
    }

    function initialsOf(p) {
        const a = (p.lastName || '').trim().charAt(0);
        const b = (p.firstName || '').trim().charAt(0);
        return (a + b).toUpperCase() || 'P';
    }

    function fullNameOf(p) {
        return [p.lastName, p.firstName, p.middleName].filter(Boolean).join(' ').trim();
    }

    function docLabel(p) {
        const map = {
            PASSPORT: '–ü–∞—Å–ø–æ—Ä—Ç',
            FOREIGN_PASSPORT: '–ó–∞–≥—Ä–∞–Ω–ø–∞—Å–ø–æ—Ä—Ç',
            ID: 'ID',
            BIRTH_CERT: '–°–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ'
        };
        const t = map[p.docType] || '–î–æ–∫—É–º–µ–Ω—Ç';
        return `${t} ${p.docNumber || ''}`.trim();
    }

    function switchProfilePassengerTab(targetId) {
        document.querySelectorAll('.passenger-editor-card .passenger-pane').forEach(pane => {
            pane.classList.toggle('is-hidden', pane.id !== targetId);
        });
        document.querySelectorAll('.passenger-editor-card .passenger-form-tabs button').forEach(btn => {
            btn.classList.toggle('is-active', btn.dataset.passengerTab === targetId);
        });
    }

    function renderPassengerList() {
        const listEl = document.getElementById('passengerList');
        const emptyEl = document.getElementById('passengerEmpty');
        if (!listEl) return;

        const q = (document.getElementById('passengerSearch')?.value || '').toLowerCase().trim();
        const passengers = loadPassengers();

        const filtered = q
            ? passengers.filter(p =>
                fullNameOf(p).toLowerCase().includes(q) ||
                (p.docNumber || '').toLowerCase().includes(q)
            )
            : passengers;

        listEl.innerHTML = '';

        if (filtered.length === 0) {
            if (emptyEl) emptyEl.style.display = 'block';
            return;
        }
        if (emptyEl) emptyEl.style.display = 'none';

        filtered.forEach(p => {
            const item = document.createElement('div');
            item.className = 'passenger-item';
            item.onclick = () => startEditPassenger(p.id);

            item.innerHTML = `
                <div class="passenger-avatar">${initialsOf(p)}</div>
                <div class="passenger-main">
                    <div class="passenger-name">${fullNameOf(p) || '–ü–∞—Å—Å–∞–∂–∏—Ä'}</div>
                    <div class="passenger-meta">
                        ${p.birthDate ? `–¥.—Ä. ${p.birthDate}` : ''}${p.birthDate ? ' ‚Ä¢ ' : ''}${docLabel(p)}
                    </div>
                </div>
                <div class="row" style="gap:8px;">
                    <button class="icon-btn"
                            type="button"
                            aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                            onclick="event.stopPropagation(); startEditPassenger('${p.id}')">‚úé</button>
                    <button class="icon-btn danger"
                            type="button"
                            aria-label="–£–¥–∞–ª–∏—Ç—å"
                            title="–£–¥–∞–ª–∏—Ç—å"
                            onclick="event.stopPropagation(); deletePassenger('${p.id}')">üóë</button>
                </div>
            `;
            listEl.appendChild(item);
        });
    }

    function startCreatePassenger() {
        editingPassengerId = null;
        setEditorTitle('–ù–æ–≤—ã–π –ø–∞—Å—Å–∞–∂–∏—Ä');
        resetPassengerForm(false);
        switchProfilePassengerTab('profileMain');
    }

    function startEditPassenger(id) {
        const passengers = loadPassengers();
        const p = passengers.find(x => x.id === id);
        if (!p) return;

        editingPassengerId = id;
        setEditorTitle('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–∞');

        document.getElementById('pLastName').value = p.lastName || '';
        document.getElementById('pFirstName').value = p.firstName || '';
        document.getElementById('pMiddleName').value = p.middleName || '';
        document.getElementById('pBirthDate').value = p.birthDate || '';
        document.getElementById('pDocType').value = p.docType || 'PASSPORT';
        document.getElementById('pDocNumber').value = p.docNumber || '';
        document.getElementById('pBenefit').value = p.benefit || '';
        document.getElementById('pLoyalty').value = p.loyalty || '';
        document.getElementById('pChildTicket').checked = !!p.childTicket;

        setGender(p.gender || '');
    }

    function setGender(g) {
        currentGender = g;
        const m = document.getElementById('pGenderM');
        const f = document.getElementById('pGenderF');
        if (!m || !f) return;

        m.classList.toggle('primary', g === 'M');
        f.classList.toggle('primary', g === 'F');
        m.classList.toggle('ghost', g !== 'M');
        f.classList.toggle('ghost', g !== 'F');
    }

    function resetPassengerForm(refreshList = true) {
        document.getElementById('pLastName').value = '';
        document.getElementById('pFirstName').value = '';
        document.getElementById('pMiddleName').value = '';
        document.getElementById('pBirthDate').value = '';
        document.getElementById('pDocType').value = 'PASSPORT';
        document.getElementById('pDocNumber').value = '';
        document.getElementById('pBenefit').value = '';
        document.getElementById('pLoyalty').value = '';
        document.getElementById('pChildTicket').checked = false;
        setGender('');
        if (refreshList) renderPassengerList();
    }

    function savePassenger() {
        const lastName = document.getElementById('pLastName').value.trim();
        const firstName = document.getElementById('pFirstName').value.trim();
        const docNumber = document.getElementById('pDocNumber').value.trim();

        if (!lastName || !firstName || !docNumber) {
            alert('–ó–∞–ø–æ–ª–Ω–∏ –º–∏–Ω–∏–º—É–º: –§–∞–º–∏–ª–∏—è, –ò–º—è, –ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞.');
            return;
        }

        const passengers = loadPassengers();
        const data = {
            id: editingPassengerId || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())),
            lastName,
            firstName,
            middleName: document.getElementById('pMiddleName').value.trim(),
            gender: currentGender,
            birthDate: document.getElementById('pBirthDate').value,
            docType: document.getElementById('pDocType').value,
            docNumber,
            benefit: document.getElementById('pBenefit').value,
            loyalty: document.getElementById('pLoyalty').value.trim(),
            childTicket: document.getElementById('pChildTicket').checked
        };

        data.name = fullNameOf(data);

        const docMap = {
            PASSPORT: '–ü–∞—Å–ø–æ—Ä—Ç',
            FOREIGN_PASSPORT: '–ó–∞–≥—Ä–∞–Ω–ø–∞—Å–ø–æ—Ä—Ç',
            ID: 'ID –∫–∞—Ä—Ç–∞',
            BIRTH_CERT: '–°–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ –æ —Ä–æ–∂–¥–µ–Ω–∏–∏'
        };

        data.document = `${docMap[data.docType] || '–î–æ–∫—É–º–µ–Ω—Ç'} ${data.docNumber || ''}`.trim();

        data.benefitType = data.benefit || '';
        data.loyaltyNumber = data.loyalty || '';

        const idx = passengers.findIndex(x => x.id === data.id);
        if (idx >= 0) passengers[idx] = data;
        else passengers.push(data);

        persistPassengers(passengers);
        editingPassengerId = data.id;

        renderPassengerList();
        alert('–ü–∞—Å—Å–∞–∂–∏—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
    }

    function deletePassenger(id) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–∞—Å—Å–∞–∂–∏—Ä–∞?')) return;
        const passengers = loadPassengers().filter(x => x.id !== id);
        persistPassengers(passengers);
        if (editingPassengerId === id) startCreatePassenger();
        renderPassengerList();
    }

    document.addEventListener('DOMContentLoaded', () => {
        renderPassengerList();
        startCreatePassenger();
        switchProfilePassengerTab('profileMain');
    });
</script>

</body>
</html>
