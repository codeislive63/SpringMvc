<!DOCTYPE html>
<html lang="ru"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <title>Выбор места • Railway Booker</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <style>
        .hint { margin-top: 10px; opacity: .8; font-size: 14px; }
        .muted { opacity: .85; }
        .seat-grid { display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
        .seat {
            min-width: 46px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.18);
            background: rgba(255,255,255,.06);
            color: #fff;
            cursor: pointer;
            transition: transform .08s ease, background .12s ease, border-color .12s ease;
        }
        .seat:hover { background: rgba(255,255,255,.10); transform: translateY(-1px); }
        .seat.is-selected {
            border-color: rgba(120,110,255,.9);
            background: rgba(120,110,255,.22);
            outline: 2px solid rgba(120,110,255,.35);
        }
        .card.is-disabled { opacity: .45; pointer-events: none; }
        .card-header { display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }
        .chip {
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(255,255,255,.08);
            border: 1px solid rgba(255,255,255,.12);
            font-size: 12px;
            white-space: nowrap;
        }
        .card h3 { margin: 0 0 8px 0; }
        .row { display:flex; gap:16px; flex-wrap:wrap; margin-top:8px; }
        .row p { margin: 0; }
    </style>
</head>
<body class="app-bg">

<header th:replace="~{fragments/topbar :: topbar}"></header>

<main class="page">
    <section class="welcome">
        <div class="section-title">
            <div class="eyebrow">Шаг 1</div>
            <h1 style="margin: 0;">Выбор места</h1>
        </div>
        <p class="muted">
            Отфильтруйте доступные места по классу и выберите услугу. Для маршрута с пересадкой сначала нужно выбрать место в первом сегменте.
        </p>
        <div class="pill-group" style="margin-top: 10px;">
            <span class="pill"><strong>Проверка</strong> доступности мест</span>
            <span class="pill"><strong>Схема</strong> вагона</span>
            <span class="pill"><strong>Услуги</strong> Wi‑Fi, питание, багаж</span>
        </div>
    </section>

    <section class="cards-grid">
        <!-- SINGLE TRIP -->
        <div th:if="${tripId != null}" style="width: 100%;">
            <article class="card">
                <div class="card-header">
                    <div>
                        <h3 th:text="${routeLabel}">Маршрут</h3>
                        <div class="row">
                            <p>Рейс: <b th:text="${tripId}"></b></p>
                            <p th:if="${trip != null}">
                                Свободных мест: <b th:text="${#lists.size(seats)}"></b>
                            </p>
                        </div>
                    </div>
                    <div class="chip">Сегмент 1</div>
                </div>

                <div class="info-grid">
                    <div class="info-tile">
                        <div class="label">Класс вагона</div>
                        <span class="value">Сидячий / Купе</span>
                    </div>
                    <div class="info-tile">
                        <div class="label">Услуги</div>
                        <span class="value">Wi‑Fi · Питание · Розетки</span>
                    </div>
                    <div class="info-tile">
                        <div class="label">Время в пути</div>
                        <span class="value">Будет указано в деталях рейса</span>
                    </div>
                </div>

                <div class="hint">Выберите место</div>
                <div class="seat-grid" data-target="seat">
                    <button type="button"
                            class="seat"
                            th:each="s : ${seats}"
                            th:text="${s}"
                            th:attr="data-seat=${s}"
                            onclick="pickSeat('seat', this)">
                    </button>
                </div>

                <div class="legend">
                    <div class="item">
                        <span class="dot"></span>
                        <span>Свободно</span>
                    </div>
                    <div class="item">
                        <span class="dot" style="background: #facc15;"></span>
                        <span>Детский/льготный тариф</span>
                    </div>
                </div>

                <form th:action="@{/booking/reserve}" method="post" class="form" style="margin-top: 16px;">
                    <input type="hidden" name="tripId" th:value="${tripId}"/>
                    <input type="hidden" name="seat" id="seat"/>

                    <h3 style="margin: 6px 0 4px;">Данные пассажира</h3>
                    <div class="form-split">
                        <div class="form-group">
                            <label for="passengerName">ФИО пассажира</label>
                            <input id="passengerName" name="passengerName" type="text" placeholder="Иванов Иван Иванович" required>
                        </div>
                        <div class="form-group">
                            <label for="document">Документ</label>
                            <input id="document" name="document" type="text" placeholder="Паспорт / ID" required>
                        </div>
                        <div class="form-group">
                            <label for="passengerType">Тип билета</label>
                            <div class="select-wrapper">
                                <select id="passengerType" name="passengerType" class="custom-select">
                                    <option value="adult">Взрослый</option>
                                    <option value="child">Детский</option>
                                    <option value="benefit">Льготный</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="contacts">Контакты</label>
                            <input id="contacts" name="contacts" type="text" placeholder="Email или телефон для билета">
                        </div>
                    </div>

                    <div class="divider-line"></div>
                    <h4 style="margin: 0 0 8px;">Дополнительные услуги</h4>
                    <div class="pill-group">
                        <label class="pill-toggle">
                            <input type="checkbox" name="meal" value="true">
                            <span>Питание</span>
                            <span class="dot"></span>
                        </label>
                        <label class="pill-toggle">
                            <input type="checkbox" name="insurance" value="true">
                            <span>Страхование</span>
                            <span class="dot"></span>
                        </label>
                        <label class="pill-toggle">
                            <input type="checkbox" name="transfer" value="true">
                            <span>Трансфер/такси</span>
                            <span class="dot"></span>
                        </label>
                        <label class="pill-toggle">
                            <input type="checkbox" name="luggage" value="true">
                            <span>Доп. багаж</span>
                            <span class="dot"></span>
                        </label>
                    </div>

                    <div class="actions" style="margin-top: 12px;">
                        <button class="btn primary" type="submit" id="reserveBtnSingle" disabled>Забронировать</button>
                        <a class="btn secondary" th:href="@{/routes/search}">Назад</a>
                    </div>
                </form>
            </article>
        </div>

        <!-- TRANSFER (2 segments) -->
        <div th:if="${tripId1 != null}" style="width: 100%;">
            <div class="cards-grid">
                <!-- CARD 1 -->
                <article class="card">
                    <div class="card-header">
                        <div>
                            <h3 th:text="${routeLabelA}">Маршрут 1</h3>
                            <div class="row">
                                <p>Рейс: <b th:text="${tripId1}"></b></p>
                                <p>Свободных мест: <b th:text="${#lists.size(seats1)}"></b></p>
                            </div>
                        </div>
                        <div class="chip">Сегмент 1</div>
                    </div>

                    <div class="hint">Сначала выберите место для первого сегмента</div>
                    <div class="seat-grid" data-target="seat1">
                        <button type="button"
                                class="seat"
                                th:each="s1 : ${seats1}"
                                th:text="${s1}"
                                th:attr="data-seat=${s1}"
                                onclick="pickSeat('seat1', this)">
                        </button>
                    </div>
                </article>

                <!-- CARD 2 -->
                <article class="card is-disabled" id="card2">
                    <div class="card-header">
                        <div>
                            <h3 th:text="${routeLabelB}">Маршрут 2</h3>
                            <div class="row">
                                <p>Рейс: <b th:text="${tripId2}"></b></p>
                                <p>Свободных мест: <b th:text="${#lists.size(seats2)}"></b></p>
                            </div>
                        </div>
                        <div class="chip">Сегмент 2</div>
                    </div>

                    <div class="hint">Станет доступно после выбора места в сегменте 1</div>
                    <div class="seat-grid" data-target="seat2">
                        <button type="button"
                                class="seat"
                                th:each="s2 : ${seats2}"
                                th:text="${s2}"
                                th:attr="data-seat=${s2}"
                                onclick="pickSeat('seat2', this)">
                        </button>
                    </div>
                </article>
            </div>

            <form th:action="@{/booking/reserve}" method="post" class="form" style="margin-top: 16px;">
                <input type="hidden" name="tripId1" th:value="${tripId1}"/>
                <input type="hidden" name="tripId2" th:value="${tripId2}"/>
                <input type="hidden" name="seat1" id="seat1"/>
                <input type="hidden" name="seat2" id="seat2"/>

                <h3 style="margin: 6px 0 4px;">Данные пассажиров</h3>
                <div class="form-split">
                    <div class="form-group">
                        <label for="passengerName1">Пассажир сегмента 1</label>
                        <input id="passengerName1" name="passengerName1" type="text" placeholder="ФИО" required>
                    </div>
                    <div class="form-group">
                        <label for="passengerName2">Пассажир сегмента 2</label>
                        <input id="passengerName2" name="passengerName2" type="text" placeholder="ФИО" required>
                    </div>
                    <div class="form-group">
                        <label for="documentTransfer">Документ</label>
                        <input id="documentTransfer" name="documentTransfer" type="text" placeholder="Паспорт / ID" required>
                    </div>
                    <div class="form-group">
                        <label for="passengerTypeTransfer">Тип билета</label>
                        <div class="select-wrapper">
                            <select id="passengerTypeTransfer" name="passengerTypeTransfer" class="custom-select">
                                <option value="adult">Взрослый</option>
                                <option value="child">Детский</option>
                                <option value="benefit">Льготный</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="divider-line"></div>
                <h4 style="margin: 0 0 8px;">Дополнительные сервисы</h4>
                <div class="pill-group">
                    <label class="pill-toggle">
                        <input type="checkbox" name="meal" value="true">
                        <span>Выбор питания</span>
                        <span class="dot"></span>
                    </label>
                    <label class="pill-toggle">
                        <input type="checkbox" name="insurance" value="true">
                        <span>Страхование</span>
                        <span class="dot"></span>
                    </label>
                    <label class="pill-toggle">
                        <input type="checkbox" name="transfer" value="true">
                        <span>Трансфер</span>
                        <span class="dot"></span>
                    </label>
                    <label class="pill-toggle">
                        <input type="checkbox" name="luggage" value="true">
                        <span>Багаж / животные</span>
                        <span class="dot"></span>
                    </label>
                </div>

                <div class="actions" style="margin-top: 12px;">
                    <button class="btn primary" type="submit" id="reserveBtnTransfer" disabled>Забронировать</button>
                    <a class="btn secondary" th:href="@{/routes/search}">Назад</a>
                </div>
            </form>
        </div>
    </section>
</main>

<script>
    function pickSeat(hiddenId, btn) {
        const grid = btn.closest('.seat-grid');
        if (grid) {
            grid.querySelectorAll('.seat').forEach(b => b.classList.remove('is-selected'));
        }
        btn.classList.add('is-selected');

        const hidden = document.getElementById(hiddenId);
        if (hidden) hidden.value = btn.dataset.seat;

        if (hiddenId === 'seat1') {
            const card2 = document.getElementById('card2');
            if (card2) card2.classList.remove('is-disabled');
        }

        const singleBtn = document.getElementById('reserveBtnSingle');
        if (singleBtn) {
            const seat = document.getElementById('seat')?.value;
            singleBtn.disabled = !(seat && seat.length > 0);
        }

        const transferBtn = document.getElementById('reserveBtnTransfer');
        if (transferBtn) {
            const seat1 = document.getElementById('seat1')?.value;
            const seat2 = document.getElementById('seat2')?.value;
            transferBtn.disabled = !(seat1 && seat2);
        }
    }
</script>

</body>
</html>
