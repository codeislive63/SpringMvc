<!DOCTYPE html>
<html lang="ru"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <title>Личный кабинет • Railway Booker</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
</head>
<body class="app-bg">

<header th:replace="~{fragments/topbar :: topbar}"></header>

<main class="page">
    <section class="welcome">
        <h1>Личный кабинет</h1>
        <p>Здравствуйте, <b th:text="${user.fullName}">Имя</b>!</p>
        <p>Email: <span th:text="${user.email}">email</span></p>
    </section>

    <section class="cards-grid">
        <article class="card">
            <h2>Профиль и бонусы</h2>
            <p class="muted">Настройки вашего аккаунта, сохранённые пассажиры и программы лояльности.</p>
            <div class="row">
                <p>Текущий уровень: <b th:text="${loyaltyTier}">Базовый</b></p>
                <p>Бонусные баллы: <b th:text="${loyaltyPoints}">0</b></p>
            </div>
            <div>
                <p class="small">Сохранённые пассажиры</p>
                <div class="actions" th:if="${!#lists.isEmpty(savedPassengers)}">
                    <span class="badge" th:each="p : ${savedPassengers}" th:text="${p}"></span>
                </div>
                <p th:if="${#lists.isEmpty(savedPassengers)}" class="muted">Пока нет сохранённых пассажиров.</p>
            </div>
            <div style="margin-top:10px;">
                <p class="small">Сохранённые документы</p>
                <div class="actions" th:if="${!#lists.isEmpty(savedDocuments)}">
                    <span class="badge" th:each="d : ${savedDocuments}" th:text="${d}"></span>
                </div>
                <p th:if="${#lists.isEmpty(savedDocuments)}" class="muted">Добавьте документы при оформлении билета — они сохранятся автоматически.</p>
            </div>
        </article>

        <!-- Активные (неоплаченные) брони -->
        <article class="card">
            <h2>Активные брони</h2>
            <div th:if="${#lists.isEmpty(unpaidTickets)}">
                <p>Нет активных бронирований.</p>
            </div>
            <div th:each="t : ${unpaidTickets}">
                <h3 th:text="${t.trip.route.origin.name + ' — ' + t.trip.route.destination.name}">Маршрут</h3>
                <p th:text="'Отправление: ' + ${#temporals.format(t.trip.departureTime, 'dd.MM.yyyy HH:mm')}"></p>
                <p th:text="'Место: ' + ${t.seatNumber}"></p>
                <p th:text="'Цена: ' + ${#numbers.formatDecimal(t.price, 1, 'COMMA', 2, 'POINT')} + ' BYN'"></p>
                <p>Статус: <span th:text="${t.status.label}"></span></p>
                <div class="actions">
                    <form th:action="@{/booking/pay/{id}(id=${t.id})}" method="post">
                        <button class="btn primary" type="submit">Оплатить</button>
                    </form>
                    <form th:action="@{/tickets/{id}/refund(id=${t.id})}" method="post"
                          onsubmit="return confirm('Отменить бронь? Место станет доступно снова.')">
                        <button class="btn danger" type="submit">Отменить</button>
                    </form>
                </div>
                <hr>
            </div>
        </article>

        <!-- Оплаченные билеты -->
        <article class="card">
            <h2>Покупки</h2>
            <div th:if="${#lists.isEmpty(paidTickets)}">
                <p>Нет оплаченных билетов.</p>
            </div>
            <div th:each="t : ${paidTickets}">
                <h3 th:text="${t.trip.route.origin.name + ' — ' + t.trip.route.destination.name}">Маршрут</h3>
                <p th:text="'Отправление: ' + ${#temporals.format(t.trip.departureTime, 'dd.MM.yyyy HH:mm')}"></p>
                <p th:text="'Место: ' + ${t.seatNumber}"></p>
                <p th:text="'Цена: ' + ${#numbers.formatDecimal(t.price, 1, 'COMMA', 2, 'POINT')} + ' BYN'"></p>
                <p>Статус: <span th:text="${t.status.label}"></span></p>
                <!-- разрешаем возврат даже для оплаченных билетов -->
                <form th:action="@{/tickets/{id}/refund(id=${t.id})}" method="post"
                      onsubmit="return confirm('Вернуть билет? Средства будут возвращены.')">
                    <button class="btn danger" type="submit">Вернуть</button>
                </form>
                <hr>
            </div>
        </article>

        <!-- Отменённые/возвращённые -->
        <article class="card">
            <h2>Отменённые билеты</h2>
            <div th:if="${#lists.isEmpty(cancelledTickets)}">
                <p>Нет отменённых или возвращённых билетов.</p>
            </div>
            <div th:each="t : ${cancelledTickets}">
                <h3 th:text="${t.trip.route.origin.name + ' — ' + t.trip.route.destination.name}">Маршрут</h3>
                <p th:text="'Отправление: ' + ${#temporals.format(t.trip.departureTime, 'dd.MM.yyyy HH:mm')}"></p>
                <p th:text="'Место: ' + ${t.seatNumber}"></p>
                <p th:text="'Цена: ' + ${#numbers.formatDecimal(t.price, 1, 'COMMA', 2, 'POINT')} + ' BYN'"></p>
                <p>Статус: <span th:text="${t.status.label}"></span></p>
                <hr>
            </div>
        </article>
    </section>
</main>
</body>
</html>
